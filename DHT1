#include <WiFi.h>
#include <SinricPro.h>
#include <SinricProSwitch.h>
#include <DHT.h>

// âœ… Cáº¥u hÃ¬nh WiFi
const char* ssid = "realme 8";
const char* password = "00001111";

// âœ… ThÃ´ng tin Sinric Pro
#define APP_KEY     "8e10eb5d-2f08-4317-908b-322a540c6239"  
#define APP_SECRET  "07f2aa77-e000-4d17-aed1-c6af2b2b8e37-51b7fd9f-232a-4fdc-83a8-833818b01bf5"
#define DEVICE_ID_1 "67d13b264dee339ca79b6f80"  // ÄÃ¨n 1
#define DEVICE_ID_2 "67d13b566066f22be0656db5"  // ÄÃ¨n 2
#define SENSOR_ID   "DHT_SENSOR"  // ID giáº£ láº­p cho cáº£m biáº¿n trÃªn Sinric Pro

// âœ… Äá»‹nh nghÄ©a chÃ¢n Relay
#define RELAY_1 33
#define RELAY_2 32

// âœ… Cáº£m biáº¿n DHT11
#define DHTPIN 4  // ChÃ¢n káº¿t ná»‘i cáº£m biáº¿n
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

// ğŸ“Œ Káº¿t ná»‘i WiFi
void connectWiFi() {
    WiFi.begin(ssid, password);
    Serial.print("Äang káº¿t ná»‘i WiFi");
    int attempt = 0;
    
    while (WiFi.status() != WL_CONNECTED && attempt < 20) {  // Giá»›i háº¡n 10 giÃ¢y
        delay(500);
        Serial.print(".");
        attempt++;
    }

    if (WiFi.status() == WL_CONNECTED) {
        Serial.println("\nâœ… Káº¿t ná»‘i WiFi thÃ nh cÃ´ng!");
    } else {
        Serial.println("\nâŒ KhÃ´ng thá»ƒ káº¿t ná»‘i WiFi!");
    }
}

// ğŸ“Œ Äá»c dá»¯ liá»‡u cáº£m biáº¿n & Ä‘Æ°a ra lá»i khuyÃªn
String getRecommendation() {
    float temperature = dht.readTemperature();
    float humidity = dht.readHumidity();

    if (isnan(temperature) || isnan(humidity)) {
        return "âš ï¸ KhÃ´ng Ä‘á»c Ä‘Æ°á»£c dá»¯ liá»‡u tá»« cáº£m biáº¿n!";
    }

    String advice = "ğŸŒ¡ Nhiá»‡t Ä‘á»™: " + String(temperature) + "Â°C - ğŸ’§ Äá»™ áº©m: " + String(humidity) + "%\n";

    if (temperature > 30) {
        advice += "ğŸ”¥ Trá»i quÃ¡ nÃ³ng! HÃ£y báº­t quáº¡t hoáº·c Ä‘iá»u hÃ²a.\n";
    } else if (temperature < 18) {
        advice += "â„ï¸ Trá»i láº¡nh! HÃ£y báº­t sÆ°á»Ÿi.\n";
    }

    if (humidity < 40) {
        advice += "ğŸ’¦ Äá»™ áº©m tháº¥p! HÃ£y báº­t mÃ¡y phun sÆ°Æ¡ng.\n";
    } else if (humidity > 70) {
        advice += "â˜ï¸ Äá»™ áº©m cao! HÃ£y má»Ÿ cá»­a sá»• Ä‘á»ƒ thÃ´ng giÃ³.\n";
    }

    return advice;
}

// ğŸ“Œ Xá»­ lÃ½ lá»‡nh báº­t/táº¯t Ä‘Ã¨n tá»« Sinric Pro
bool onPowerState1(const String &deviceId, bool &state) {
    digitalWrite(RELAY_1, state ? HIGH : LOW);
    Serial.printf("ğŸ’¡ ÄÃ¨n 1 %s\n", state ? "Báº¬T" : "Táº®T");

    if (state) {  // Náº¿u Ä‘Ã¨n Ä‘Æ°á»£c báº­t, hiá»ƒn thá»‹ khuyáº¿n nghá»‹
        String advice = getRecommendation();
        Serial.println(advice);
    }

    return true;
}

bool onPowerState2(const String &deviceId, bool &state) {
    digitalWrite(RELAY_2, state ? HIGH : LOW);
    Serial.printf("ğŸ’¡ ÄÃ¨n 2 %s\n", state ? "Báº¬T" : "Táº®T");

    if (state) {  // Náº¿u Ä‘Ã¨n Ä‘Æ°á»£c báº­t, hiá»ƒn thá»‹ khuyáº¿n nghá»‹
        String advice = getRecommendation();
        Serial.println(advice);
    }

    return true;
}

void setup() {
    Serial.begin(115200);
    dht.begin();

    connectWiFi();

    // âœ… Cáº¥u hÃ¬nh chÃ¢n Relay
    pinMode(RELAY_1, OUTPUT);
    pinMode(RELAY_2, OUTPUT);
    digitalWrite(RELAY_1, LOW);
    digitalWrite(RELAY_2, LOW);

    // âœ… Cáº¥u hÃ¬nh thiáº¿t bá»‹ trÃªn Sinric Pro
    SinricProSwitch &myLight1 = SinricPro[DEVICE_ID_1];
    myLight1.onPowerState(onPowerState1);

    SinricProSwitch &myLight2 = SinricPro[DEVICE_ID_2];
    myLight2.onPowerState(onPowerState2);

    SinricPro.begin(APP_KEY, APP_SECRET);
}

void loop() {
    if (WiFi.status() != WL_CONNECTED) {
        Serial.println("ğŸ”„ WiFi bá»‹ máº¥t káº¿t ná»‘i! Äang thá»­ káº¿t ná»‘i láº¡i...");
        connectWiFi();
    }
    
    SinricPro.handle();
}
